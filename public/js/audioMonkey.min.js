function AudioMonkey(){this["class"]="AudioMonkey",AudioBufferSourceNode.prototype.FINISHED_STATE=3,AudioBufferSourceNode.prototype.PLAYING_STATE=2,AudioBufferSourceNode.prototype.SCHEDULED_STATE=1,AudioBufferSourceNode.prototype.UNSCHEDULED_STATE=0,this.FADE_TIME=1,this.FREQ_MUL=7e3,this.QUAL_MUL=30,this.context=!1,this.manifest={},this.sounds={},this.init=function(){try{this.stopAll(),this.context||(window.AudioContext=window.AudioContext||window.webkitAudioContext,this.context=new AudioContext);for(var s in this.manifest)this.load(s,this.manifest[s])}catch(t){}},this.syncStream=function(s){try{var t=new Uint8Array(s.response);t.indexOf=Array.prototype.indexOf;for(var e=s.sync,o=t;;){if(s.retry++,e=o.indexOf(255,e),-1==e||o[e+1]&!0)break;e++}if(-1!=e){var n=s.response.slice(e);return delete s.response,s.response=null,s.response=n,s.sync=e,!0}}catch(u){log("error",u)}return!1},this.cloneAudioBuffer=function(s){try{for(var t=[],e=0,o=s.numberOfChannels,n=0;o>n;n++)try{t[n]=new Float32Array(s.getChannelData(n)),e++}catch(u){}for(var i=this.context.createBuffer(s.numberOfChannels,s.length,s.sampleRate),n=0;o>n;n++)try{i.getChannelData(n).set(t[n])}catch(u){}return i}catch(u){return log("error",u),!1}},this.decode=function(s,t){var e=this,o=function(){e.syncStream(t)?(e.sounds[s].buffer=e.context.createBuffer(t.response,!1),e.sounds[s].loaded=!0):(e.sounds[s].buffer=e.context.createBuffer(t.response,!1),e.sounds[s].loaded=!0)};e.context.decodeAudioData(t.response,function(t){"undefined"!=typeof e.sounds[s]&&(e.sounds[s].buffer=t,e.sounds[s].loaded=!0)},o)},this.stopAll=function(){for(var s in this.sounds)this.stop(s)},this.pauseAll=function(){for(var s in this.sounds)try{if(this.sounds[s].pausedAt=Date.now(),"undefined"==typeof this.sounds[s]||!this.sounds[s].loaded||!this.sounds[s].sound||this.sounds[s].sound&&this.sounds[s].sound.playbackState&&this.sounds[s].sound.playbackState==AudioBufferSourceNode.FINISHED_STATE)continue;this.sounds[s].sound.stop||(this.sounds[s].sound.stop=this.sounds[s].sound.noteOff);try{this.sounds[s].sound.stop(0)}catch(t){}"undefined"==typeof this.sounds[s].playbackState&&(this.sounds[s].playbackState=AudioBufferSourceNode.FINISHED_STATE)}catch(t){log("error",t)}},this.resumeAll=function(){for(var s in this.sounds)this.play(s)},this.add=function(s,t){this.manifest[s]=t},this.remove=function(s){try{delete this.manifest[s],this.stop(s),"undefined"!=typeof this.sounds[s]&&(this.sounds[s].sound=null,this.sounds[s].gain=null,this.sounds[s].buffer=null,delete this.sounds[s])}catch(t){log("error",t)}},this.load=function(s,t){try{var e=this,o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="arraybuffer",this.sounds[s]={sound:!1,buffer:!1,gain:!1,filter:!1,loaded:!1,fadding:!1,startTime:0,startedAt:!1,pausedAt:!1},o.onload=function(){o.buf=o.response,o.sync=0,o.retry=0,e.decode(s,o)},o.send()}catch(n){log("error",n)}},this.play=function(s,t,e,o,n,u,i,d){try{if("undefined"==typeof this.sounds[s]||!this.sounds[s].loaded||this.sounds[s].fadding)return;if(0==window.globalVolume&&this.sounds[s].sound)return this.stop(s);if(0==window.globalVolume)return;if(this.sounds[s].reversed&&o>0)return this.stop(s);if(this.sounds[s].sound&&this.sounds[s].sound.playbackState==AudioBufferSourceNode.PLAYING_STATE&&!this.sounds[s].reversed){if(n)return;this.stop(s)}var r=this.context.createBufferSource();this.sounds[s].sound=r,this.sounds[s].reversed=!1;var a=this.sounds[s].buffer;0>o&&(a=this.cloneAudioBuffer(this.sounds[s].buffer),Array.prototype.reverse.call(a.getChannelData(0)),Array.prototype.reverse.call(a.getChannelData(1))),r.buffer=a,o&&(r.playbackRate.value=Math.abs(parseFloat(o))),n&&(r.loop=!0,r.loopStart=0,r.loopEnd=this.sounds[s].buffer.duration),n&&u&&(r.loopStart=u),n&&i&&(r.loopEnd=i),r.start||(r.start=r.noteOn),o>0?r.start(this.context.currentTime,t*this.sounds[s].buffer.duration*o+e):r.start(this.context.currentTime,t*this.sounds[s].buffer.duration+e);var h=this.context.createGain();this.sounds[s].gain=h,r.connect(h),h.connect(this.context.destination),"undefined"!=typeof this.sounds[s].gain.gain&&(this.sounds[s].gain.gain.value=d*window.globalVolume),this.sounds[s].startTime=this.context.currentTime,this.sounds[s].startedAt=Date.now(),"undefined"==typeof this.sounds[s].playbackState&&(this.sounds[s].playbackState=AudioBufferSourceNode.PLAYING_STATE)}catch(f){log("error",f)}},this.reverse=function(s){try{if("undefined"==typeof this.sounds[s]||!this.sounds[s].loaded||!this.sounds[s].sound||this.sounds[s].reversed)return;this.sounds[s].reversed=!0;var t=this.cloneAudioBuffer(this.sounds[s].buffer);Array.prototype.reverse.call(t.getChannelData(0)),Array.prototype.reverse.call(t.getChannelData(1)),this.sounds[s].sound.loop=!1,this.sounds[s].sound.buffer=t,this.sounds[s].sound.start(this.context.currentTime,this.sounds[s].sound.loopStart)}catch(e){log("error",e)}},this.rate=function(s,t){try{if("undefined"==typeof this.sounds[s]||!this.sounds[s].loaded||!this.sounds[s].sound||this.sounds[s].reversed)return;"undefined"==typeof this.sounds[s].playbackState&&(this.sounds[s].playbackState=AudioBufferSourceNode.PLAYING_STATE),t&&(this.sounds[s].sound.playbackRate.value=Math.abs(parseFloat(t)))}catch(e){log("error",e)}},this.volume=function(s,t){try{if("undefined"==typeof this.sounds[s]||!this.sounds[s].loaded||!this.sounds[s].sound||this.sounds[s].reversed)return;"undefined"==typeof this.sounds[s].playbackState&&(this.sounds[s].playbackState=AudioBufferSourceNode.PLAYING_STATE),"undefined"!=typeof this.sounds[s].gain.gain&&(this.sounds[s].gain.gain.cancelScheduledValues(this.context.currentTime),this.sounds[s].gain.gain.setValueAtTime(t*window.globalVolume,this.context.currentTime))}catch(e){log("error",e)}},this.changeFrequency=function(s,t){try{var e=40,o=this.context.sampleRate/2,n=Math.log(o/e)/Math.LN2,u=Math.pow(2,n*(t-1));this.sounds[s].filter.frequency.value=o*u}catch(i){log("error",i)}},this.changeQuality=function(s,t){try{this.sounds[s].filter.Q.value=t*this.QUAL_MUL}catch(e){log("error",e)}},this.stop=function(s){try{if("undefined"==typeof this.sounds[s]||!this.sounds[s].loaded||!this.sounds[s].sound||this.sounds[s].sound&&this.sounds[s].sound.playbackState&&this.sounds[s].sound.playbackState==AudioBufferSourceNode.FINISHED_STATE)return;this.sounds[s].sound.stop||(this.sounds[s].sound.stop=this.sounds[s].sound.noteOff);try{this.sounds[s].sound.stop(0),this.sounds[s].sound=!1}catch(t){log("error",t)}"undefined"==typeof this.sounds[s].playbackState&&(this.sounds[s].playbackState=AudioBufferSourceNode.FINISHED_STATE)}catch(t){log("error",t)}},this.fadeOut=function(s){try{if("undefined"==typeof this.sounds[s]||!this.sounds[s].loaded||!this.sounds[s].sound||this.sounds[s].sound&&this.sounds[s].sound.playbackState==AudioBufferSourceNode.FINISHED_STATE)return;var t=this,e=50,o=function(s,n){return 0>n?t.sounds[s].sound.stop():("undefined"!=typeof t.sounds[s].gain.gain&&(t.sounds[s].gain.gain.value=n),void setTimeout(function(){o(s,n-.05)},e))};"undefined"!=typeof t.sounds[s].gain.gain&&o(s,t.sounds[s].gain.gain.value)}catch(n){log("error",n)}},this.fadeIn=function(s){try{if("undefined"==typeof this.sounds[s]||!this.sounds[s].loaded||!this.sounds[s].sound||this.sounds[s].sound&&this.sounds[s].sound.playbackState==AudioBufferSourceNode.FINISHED_STATE)return;this.sounds[s].fadding=!0;var t=this,e=50,o=function(s,n){return n>1?t.sounds[s].fadding=!1:("undefined"!=typeof t.sounds[s].gain.gain&&(t.sounds[s].gain.gain.value=n),void setTimeout(function(){o(s,n+.05)},e))};o(s,0)}catch(n){log("error",n)}},this.crossfade=function(s,t){try{var e=this.sounds[s].sound,o=this.sounds[s].gain,n=this.sounds[s].buffer.duration,u=this.context.currentTime;o.gain.linearRampToValueAtTime(0,u),o.gain.linearRampToValueAtTime(1,u+this.FADE_TIME),e.start(0),o.gain.linearRampToValueAtTime(1,u+n-ctx.FADE_TIME),o.gain.linearRampToValueAtTime(0,u+n);var i=arguments.callee;this.timer=setTimeout(function(){i(t,s)},1e3*(n-this.FADE_TIME))}catch(d){log("error",d)}}}