var vehicle={};vehicle.Accelerometer=function(){this.prevPosition=new Math3D.geometry.Vector3(0,0,0),this.prevVelocity=new Math3D.geometry.Vector3(0,0,0),this.position=new Math3D.geometry.Vector3(0,0,0),this.velocity=new Math3D.geometry.Vector3(0,0,0),this.acceleration=new Math3D.geometry.Vector3(0,0,0),this.update=function(e,t){var i=this.prevPosition,s=this.position;i.x=s.x,i.y=s.y,i.z=s.z;var i=this.position;i.x=t.x,i.y=t.y,i.z=t.z;var i=this.prevVelocity,s=this.velocity;i.x=s.x,i.y=s.y,i.z=s.z,this.velocity=Math3D.geometry.Vector3.subVV(this.position,this.prevPosition).div(e),this.acceleration=Math3D.geometry.Vector3.subVV(this.velocity,this.prevVelocity).div(e)},this.getG=function(){return this.acceleration.get_magnitude()/9.80665},this.getVector=function(){return this.acceleration.clone()}},vehicle.Box2DUtils=function(){},vehicle.Box2DUtils.toKmh=function(e){return 3600*e/1e3},vehicle.Box2DUtils.toMps=function(e){return 1e3*e/3600},vehicle.Box2DUtils.createBox=function(e,t,i,s,h,a,o,r,n,l){null==l&&(l=.2),null==n&&(n=.5),null==r&&(r=1),null==o&&(o=0);var c=new box2D.dynamics.B2BodyDef;c.type=box2D.dynamics.B2Body.b2_staticBody,c.position.set(t,i);var g=new box2D.dynamics.B2FixtureDef;g.density=r,g.friction=n,g.restitution=l;var d=new box2D.collision.shapes.B2PolygonShape;d.setAsBox(s,h),g.shape=d;var p=e.createBody(c);return null!=a&&p.setPosition(a),p.setAngle(o),p.createFixture(g),p},vehicle.Box2DUtils.createCircle=function(e,t,i,s,h,a,o){null==o&&(o=.2),null==a&&(a=.5),null==h&&(h=1);var r=new box2D.dynamics.B2BodyDef;r.type=box2D.dynamics.B2Body.b2_dynamicBody,r.position.set(t,i);var n=new box2D.dynamics.B2FixtureDef;n.density=h,n.friction=a,n.restitution=o;var l=new box2D.collision.shapes.B2CircleShape;l.setRadius(s),n.shape=l;var c=e.createBody(r);return c.createFixture(n),c},vehicle.Box2DUtils.createEdge=function(e,t,i,s,h){var a=new box2D.dynamics.B2BodyDef;a.type=box2D.dynamics.B2Body.b2_staticBody;var o=new box2D.common.math.B2Vec2(t,i),r=new box2D.common.math.B2Vec2(s,h),n=new box2D.collision.shapes.B2PolygonShape;n.setAsEdge(o,r);var l=e.createBody(a);return l.createFixture2(n),l},vehicle.Box2DUtils.createPolygon=function(e,t,i,s,h,a,o,r,n){if(null==n&&(n=65535),null==r&&(r=1),null==o&&(o=.2),null==a&&(a=.5),null==h&&(h=1),null==s&&(s=0),t.length>=3){for(var l=0,c=t.length,g=0;c>g;){var d=g++;l+=(t[d].x+t[(d+1)%c].x)*(t[(d+1)%c].y-t[d].y)}0>l&&t.reverse()}var p=new box2D.dynamics.B2BodyDef;p.type=box2D.dynamics.B2Body.b2_staticBody,null!=i&&p.position.set(i.x,i.y),p.angle=s;var u=new box2D.collision.shapes.B2PolygonShape;u.setAsVector(t);var m=new box2D.dynamics.B2FixtureDef;m.density=h,m.friction=a,m.restitution=o,m.shape=u,m.filter.categoryBits=r,m.filter.maskBits=n;var y=e.createBody(p);return y.createFixture(m),y},vehicle.Box2DUtils.getFrontVector=function(e){return e.getWorldVector(new box2D.common.math.B2Vec2(0,-1))},vehicle.Box2DUtils.project=function(e,t){return box2D.common.math.B2Math.mulFV(box2D.common.math.B2Math.dot(e,t),e)},vehicle.GearBox=function(){this.gear=1,this.differentialRatio=3.42,this.gearRatio={"-1":-2.9,1:2.66,2:1.78,3:1.3,4:1,5:.74,6:.5},this.gearRatioTopSpeed={"-1":.2,1:.2,2:.4,3:.6,4:.8,5:1,6:1.2},this.maxGear=6,this.getGearRatio=function(){var e=this.gear;return this.gearRatio[e]},this.getPreviousGearRatio=function(){var e=this.gear-1;return this.gearRatio[e]},this.gearUp=function(){this.gear<this.maxGear&&(this.gear+=1),0==this.gear&&(this.gear=1)},this.gearDown=function(){this.gear>-1&&(this.gear-=1),0==this.gear&&(this.gear=-1)},this.getCurrentGear=function(){return this.gear}},vehicle.Light=function(){this.targetBrightness=0,this.brightness=0,this.turnOn=function(){this.targetBrightness=1},this.turnOff=function(){this.targetBrightness=0},this.update=function(e){var t=this.brightness;this.brightness=t+(this.targetBrightness-t)*(1-Math.exp(-20*e))}},vehicle.MagicFormula=function(e,t,i,s){this.b=e,this.c=t,this.d=i,this.e=s,this.calc=function(e){return this.d*Math.sin(this.c*Math.atan(this.b*(1-this.e)*e+this.e*Math.atan(this.b*e)))}},vehicle.Steering=function(e,t){this.deltaAngle=0,this.lever=0,this.angle=0,this.maxAngle=e,this.rudderAngleScale=t,this.update=function(e,t,i){this.deltaAngle=8.72664625997165*this.lever*e,this.angle+=this.deltaAngle;var s=Math3D.MyMath.linearClampMap(Math.abs(i),10,20,1,0);Math.isNaN(s)&&(s=0);var h=Math3D.MyMath.linearMap(Math3D.MyMath.clamp(.5*t,-100,100),0,70,0,8),a=this.angle;this.angle=a+(0-a)*(1-Math.exp(-(h*s)*e)),this.angle=Math3D.MyMath.clamp(this.angle,-this.maxAngle,this.maxAngle),isNaN(this.angle)&&(this.angle=0)},this.setLever=function(e){this.lever=e},this.setDeltaAngle=function(e){this.deltaAngle=e},this.getRudderAngle=function(){return this.angle/this.rudderAngleScale}},vehicle.Suspension=function(e,t,i,s,h){null==h&&(h=5e3),null==s&&(s=8e4),null==i&&(i=375),this.velocity=0,this.position=e,this.targetPosition=t,this.mass=i,this.spring=s,this.damper=h,this.loop=!1,this.update=function(e){var t=this.loop?this.spring*this.position-this.damper*this.velocity:this.spring*(this.targetPosition-this.position)-this.damper*this.velocity;isNaN(t)&&(t=0);var i=t/this.mass;isNaN(i)&&(i=0),this.velocity+=i*e,isNaN(this.velocity)&&(this.velocity=0),this.position+=this.velocity*e,isNaN(this.position)&&(this.position=0)}},vehicle.Scaler=function(e,t,i,s,h){null==h&&(h=.25),null==s&&(s=1),null==i&&(i=.5),this.velocity=0,this.position=e,this.targetPosition=t,this.velocity=0,this.mass=i,this.spring=s,this.damper=h,this.update=function(e){var t=this.spring+this.targetPosition*e-this.damper;this.velocity+=parseInt(t),isNaN(this.velocity)&&(this.velocity=0),this.position<this.targetPosition?this.position+=this.velocity*e:this.position>this.targetPosition&&(this.position-=this.velocity*e)}},vehicle.Vehicle=function(e,t,i,s,h,a,o,r,n,l){this.vehicleData=r,this.username=n,this.other=l,this.dTilt=0,this.roll=0,this.tilt=0,this.upCount=0,this.downCount=0,this.up=!1,this.down=!1,this.left=!1,this.right=!1,this.wheelie=!1,this.crashed=!1,this.crashedTime=!1,this.crashedWithLimits=!1,this.crashedWithLimitsData=!1,this.crashedWithUser=!1,this.crashedWithUserData=!1,this.airborne=!1,this.airborneTime=!1,this.wasAirborne=!1,this.dropping=!1,this.droppingForce=0,this.isHoverAbsoluteCeiling=!1,this.altitudeOffset=0,this.tiltOffset=180,this.rollOffset=0,this.liftOffMinSpeed=70,this.brakeRatio=1,this.handbrake=0,this.squealLevel=0,this.gearChangeTime=0,this.brakeLock=!0,this.spec=i,this.automatic=o,this.speedForward=0,this.konamiCodeFast=!1,this.konamiCodeSuperFast=!1,this.konamiCodeFourWheels=!1,this.konamiCodeFly=!1,this.steering=new vehicle.Steering(this.vehicleData.maxSteeringAngle,this.vehicleData.rudderAngleScale),this.gearBox=new vehicle.GearBox,this.accelerometer=new vehicle.Accelerometer,this.gVector=new Math3D.geometry.Vector3(0,0,0);var c=new box2D.dynamics.B2BodyDef;c.type=box2D.dynamics.B2Body.b2_dynamicBody,c.position.set(s,h),c.angle=a;var g=new box2D.collision.shapes.B2PolygonShape;if(g.setAsVector(t),this.body=e.createBody(c),!this.body)return!1;this.body.createFixture2(g),this.body.setUserData(this);var d=new box2D.collision.shapes.B2MassData;d.I=this.vehicleData.massI,d.mass=this.vehicleData.mass,d.center=new box2D.common.math.B2Vec2(0,-(1-this.vehicleData.slipFactor)),this.body.setMassData(d);var p=i.rearY-i.wheelBase;if(this.wheels=[],"plane"==this.vehicleData.type){var u=i.rearY+i.wheelBase;this.wheels.push(new vehicle.Wheel(this,"Rear Left",-i.tread/2,u,.1,0,a)),this.wheels.push(new vehicle.Wheel(this,"Rear Right",i.tread/2,u,-.1,0,a)),this.wheels.push(new vehicle.Wheel(this,"Front Left",-i.tread/2,-u,.1,0,a)),this.wheels.push(new vehicle.Wheel(this,"Front Right",i.tread/2,-u,-.1,0,a)),this.wheels.push(new vehicle.Wheel(this,"Middle Left",-i.tread/2,0,.1,0,a)),this.wheels.push(new vehicle.Wheel(this,"Middle Right",i.tread/2,0,-.1,0,a))}else if("person"==this.vehicleData.type){var u=i.rearY+i.wheelBase;this.wheels.push(new vehicle.Wheel(this,"Front Left",-i.tread/2,-u,.1,0,a)),this.wheels.push(new vehicle.Wheel(this,"Front Right",i.tread/2,-u,-.1,0,a)),this.wheels.push(new vehicle.Wheel(this,"Rear Left",-i.tread/2,u,.1,0,a)),this.wheels.push(new vehicle.Wheel(this,"Rear Right",i.tread/2,u,-.1,0,a))}else this.wheels.push(new vehicle.Wheel(this,"Front Left",-i.tread/2,p,.1,0,a)),this.wheels.push(new vehicle.Wheel(this,"Front Right",i.tread/2,p,-.1,0,a)),this.wheels.push(new vehicle.Wheel(this,"Rear Left",-i.tread/2,i.rearY,.1,0,a)),this.wheels.push(new vehicle.Wheel(this,"Rear Right",i.tread/2,i.rearY,-.1,0,a));this.destroy=function(){for(var e=0,t=this.wheels.length;t>e;e++)cesiumExplorer.physics.removeBodies.push(this.wheels[e].body);cesiumExplorer.physics.removeBodies.push(this.body)},this.setSteeringDeltaAngle=function(e){this.steering.setDeltaAngle(e)},this.setSteeringLever=function(e){this.steering.setLever(e)},this.setThrottle=function(e){this.throttle=Math3D.MyMath.clamp(e,0,1*window.speedMultiplier)},this.setBrake=function(e){this.brake=Math3D.MyMath.clamp(e,0,1)},this.setHandbrake=function(e){this.handbrake=Math3D.MyMath.clamp(e,0,1)},this.setUp=function(e){this.up=e},this.setDown=function(e){this.down=e},this.setLeft=function(e){this.left=e},this.setRight=function(e){this.right=e},this.gearUp=function(){this.automatic||this.gearBox.gearUp()},this.gearDown=function(){this.automatic||this.gearBox.gearDown()},this.getRPM=function(){var e=this.gearBox.getCurrentGear(),t=this.vehicleData.maxspeed*Math.max(1,parseInt(window.speedMultiplier)/2.5),i=e>1?this.gearBox.gearRatioTopSpeed[e-1]*t:0,s=100*(this.speedKmh-i)/(this.gearBox.gearRatioTopSpeed[e]*t-i);return Math.max(s,s+10*e)},this.update=function(e){this.speed=this.body.getLinearVelocity().length(),this.speedKmh=vehicle.Box2DUtils.toKmh(this.speed);var t=0;"air"!=this.vehicleData.mainCategory&&(t=1*((this.wheels[0].slipAngle+this.wheels[1].slipAngle)/2).toDeg()),this.steering.update(e,this.speedKmh/1,t);var i=this.steering.getRudderAngle(),s=Math.tan(Math.PI/2-i)*Math.max(this.spec.wheelBase,1);"plane"==this.vehicleData.type?(this.frontLAngle=-Math.atan(Math.max(this.spec.wheelBase,1)/(s+this.spec.tread/2)),this.frontRAngle=-Math.atan(Math.max(this.spec.wheelBase,1)/(s-this.spec.tread/2))):(this.frontLAngle=Math.atan(Math.max(this.spec.wheelBase,1)/(s+this.spec.tread/2)),this.frontRAngle=Math.atan(Math.max(this.spec.wheelBase,1)/(s-this.spec.tread/2)));{var h=Math.abs(s)+this.spec.tread/2,a=Math.max(this.spec.wheelBase,1);Math.sqrt(h*h+a*a)}this.wheels.length>0&&this.wheels[0].setAngle(this.frontLAngle),this.wheels.length>1&&this.wheels[1].setAngle(this.frontRAngle),"person"==this.vehicleData.type&&(this.wheels.length>2&&this.wheels[2].setAngle(-this.frontLAngle),this.wheels.length>3&&this.wheels[3].setAngle(-this.frontRAngle)),this.speedForward=box2D.common.math.B2Math.dot(this.body.getLinearVelocity(),vehicle.Box2DUtils.getFrontVector(this.body));var o=this.gearBox.getCurrentGear(),r=this.vehicleData.maxspeed*Math.max(1,parseInt(window.speedMultiplier)/2.5);if(this.automatic||"air"==this.vehicleData.mainCategory)switch(o){case 1:if(this.speedForward<1&&this.brake>.1)this.brakeLock=!0,this.gearChangeTime+=e,this.gearChangeTime>.4&&this.gearBox.gearDown();else{this.gearChangeTime=0;{this.gearBox.getGearRatio(),this.gearBox.getPreviousGearRatio()}this.speedKmh>=this.gearBox.gearRatioTopSpeed[o]*r&&this.gearBox.gearUp()}this.throttle>0&&(this.brakeLock=!1),this.brakeLock&&(this.brake=1);break;case-1:this.speedForward>-1&&this.throttle>.1?(this.brakeLock=!0,this.gearChangeTime+=e,this.gearChangeTime>.4&&this.gearBox.gearUp()):this.gearChangeTime=0;var n=this.throttle;this.throttle=this.brake,this.brake=n,this.throttle>0&&(this.brakeLock=!1),this.brakeLock&&(this.brake=1);break;default:{this.gearBox.getGearRatio(),this.gearBox.getPreviousGearRatio()}this.speedKmh>=this.gearBox.gearRatioTopSpeed[o]*r?this.gearBox.gearUp():this.speedKmh<=this.gearBox.gearRatioTopSpeed[o-1]*r&&this.gearBox.gearDown()}"air"==this.vehicleData.mainCategory&&"helicopter"!=this.vehicleData.category&&this.tilt<0&&this.tilt>-3&&this.throttle<1&&(this.throttle=Math.abs(this.tilt)),this.throttle<=0&&this.brake<=0&&(this.brake=.1);var l=Math.abs(1e3*this.dTilt),c=0;c=this.speedForward>0&&this.airborne&&"air"!=this.vehicleData.mainCategory&&!this.konamiCodeFly?2e3*-this.throttle*this.gearBox.getGearRatio()*(this.konamiCodeSuperFast?4:this.konamiCodeFast?2:1):o>0&&"helicopter"==this.vehicleData.category&&!this.airborne?0:0>o&&"helicopter"==this.vehicleData.category&&!this.airborne?0:this.speedKmh<this.vehicleData.maxspeed*Math.max(1,parseInt(window.speedMultiplier)/2.5)*(this.konamiCodeSuperFast?4:this.konamiCodeFast?2:1)?2e3*this.throttle*this.gearBox.getGearRatio()*(this.konamiCodeSuperFast?4:this.konamiCodeFast?2:1):2e3*-this.throttle*this.gearBox.getGearRatio()*(this.konamiCodeSuperFast?4:this.konamiCodeFast?2:1),!this.automatic&&"air"!=this.vehicleData.mainCategory&&o>0?this.speedKmh>=this.gearBox.gearRatioTopSpeed[o]*r&&(c*=-1):"air"!=this.vehicleData.mainCategory&&0>o&&this.speedKmh>=this.gearBox.gearRatioTopSpeed[o]*r&&(c=0),"air"==this.vehicleData.mainCategory&&(this.isHoverAbsoluteCeiling&&this.tilt>.1&&this.tilt<3?c>0&&(c*=-1):this.tilt>.5&&this.tilt<2.5&&(c-=c-this.tilt));var g=5e3*this.brake*this.brakeRatio;if(this.wheels.length>2&&!this.vehicleData.fourWheelDrive&&!this.konamiCodeFourWheels)if("air"==this.vehicleData.mainCategory||this.konamiCodeFly)for(var d=2,p=this.wheels.length;p>d;d++)this.wheels[d].drivingForce=c;else for(var d=2,p=this.wheels.length;p>d;d++)this.wheels[d].drivingForce=c-l;else if(this.wheels.length>0)if("air"==this.vehicleData.mainCategory||this.konamiCodeFly)for(var d=0,p=this.wheels.length;p>d;d++)this.wheels[d].drivingForce=c;else for(var d=0,p=this.wheels.length;p>d;d++)this.wheels[d].drivingForce=this.vehicleData.fourWheelDrive||this.konamiCodeFourWheels?.5*(c-l):c-l;if(this.wheels.length>0&&(this.wheels[0].brakeForce=g+25+l),this.wheels.length>1&&(this.wheels[1].brakeForce=g+25+l),"air"==this.vehicleData.mainCategory||this.konamiCodeFly){if(this.wheels.length>=2)for(var d=2,p=this.wheels.length;p>d;d++)this.wheels[d].brakeForce=g+25+l}else{var u=5e3*this.handbrake;if(this.handbrake){var m=c?Math.min(c/this.vehicleData.massI,1):1,y=this.getSteeringAngle()*this.speedForward*m*Math.PI/180;this.body.m_angularVelocity+=y}if(this.wheels.length>=2)for(var d=2,p=this.wheels.length;p>d;d++)this.wheels[d].brakeForce=g+u+25+l}var v=.025*-this.gVector.y,w=.015*this.gVector.x;if("air"!=this.vehicleData.mainCategory&&!this.konamiCodeFly&&this.wheels.length>0&&(this.wheels[0].set_loadFactor(1-v-w),this.wheels[1].set_loadFactor(1-v+w),this.wheels.length>=2))for(var d=2,p=this.wheels.length;p>d;d+=2)this.wheels[d].set_loadFactor(1+v-w),this.wheels.length>d+1&&this.wheels[d+1].set_loadFactor(1+v+w);this.squealLevel=0;for(var o=0,f=this.wheels;o<f.length;){var b=f[o];++o,b.update(e),this.squealLevel+=b.getSquealLevel()}if(this.squealLevel/=4,this.wasAirborne&&!this.airborne?this.squealLevel=.5:(this.handbrake&&"air"!=this.vehicleData.mainCategory||this.crashed)&&this.squealLevel<.5&&this.speed>.1&&!this.airborne&&(this.squealLevel=.5),"air"!=this.vehicleData.mainCategory&&!this.konamiCodeFly||this.tilt>.5&&this.tilt<2.5&&(this.tilt>0||this.speedKmh<this.vehicleData.maxspeed*Math.max(1,parseInt(window.speedMultiplier)/2.5)*1.5)){this.airDragForce=this.speedKmh*this.speedKmh*.04861111111111111;var D=this.body.getLinearVelocity().copy();D.negativeSelf(),D.normalize(),D.multiply(this.airDragForce),this.body.applyForce(D,this.body.getWorldCenter())}if("air"!=this.vehicleData.mainCategory&&!this.konamiCodeFly||!this.airborne){this.rrForce=.04861111111111111*this.speedKmh;var x=this.body.getLinearVelocity().copy();x.negativeSelf(),x.normalize(),x.multiply(this.rrForce),this.body.applyForce(x,this.body.getWorldCenter())}if("air"!=this.vehicleData.mainCategory&&!this.konamiCodeFly||this.tilt>.5&&this.tilt<2.5&&(this.tilt>0||this.speedKmh<this.vehicleData.maxspeed*Math.max(1,parseInt(window.speedMultiplier)/2.5)*1.5)){var B=this.body.getWorldVector(new box2D.common.math.B2Vec2(0,-1)),M=-this.getMass()*this.vehicleData.gravity*Math.sin(this.tilt);B.multiply(M),this.body.applyForce(B,this.body.getWorldCenter())}if("air"!=this.vehicleData.mainCategory&&!this.konamiCodeFly||this.tilt>.5&&this.tilt<2.5&&(this.tilt>0||this.speedKmh<this.vehicleData.maxspeed*Math.max(1,parseInt(window.speedMultiplier)/2.5)*1.5)){var F=this.body.getWorldVector(new box2D.common.math.B2Vec2(1,0)),k=-this.getMass()*this.vehicleData.gravity*Math.sin(this.roll);Math.abs(k)>3e3&&(F.multiply(k),this.body.applyForce(F,this.body.getWorldCenter()))}},this.lateUpdate=function(e){var t=this.body.getWorldCenter(),i=new Math3D.geometry.Vector3(t.x,t.y,0);this.accelerometer.update(e,i),this.gVector=this.accelerometer.getVector(),this.gVector.y=-this.gVector.y,this.gVector.rotateZ(this.body.getAngle()+Math.PI)},this.getGear=function(){return this.gearBox.getCurrentGear()},this.getPosition=function(){var e=this.body.getWorldCenter();return new Math3D.geometry.Vector3(e.x,e.y,0)},this.getMass=function(){return this.body.getMass()},this.getAirDragForce=function(){return this.airDragForce},this.getTurningRadius=function(){return this.turningRadius},this.getSteeringAngle=function(){return this.steering.angle},this.getHeading=function(){return this.body.getAngle()},this.getSpec=function(){return this.spec},this.getSquealLevel=function(){return this.squealLevel},this.setAttitude=function(e,t){this.dTilt=e-this.tilt,this.tilt=e,this.roll=t},this.getSpeedKmh=function(){return this.speedKmh},this.getSpeedMph=function(){return vehicle.Box2DUtils.toKmh(Math.abs(this.speed))/1.609344},this.getGVector=function(){return this.gVector},this.getWheelNumber=function(){return this.wheels.length},this.getWheel=function(e){if(0>e||e>=this.wheels.length)throw"Out of wheel index";return this.wheels[e]},this.getWheelPosition=function(e){return this.getWheel(e).getPosition()}},vehicle.VehicleSpec=function(){},vehicle.Wheel=function(e,t,i,s,h,a,o,r){null==r&&(r=!0),this.loadFactor=1,this.brakeForce=0,this.drivingForce=0,this.name=t,this.isDrivingWheel=r,this.magicFormula=new vehicle.MagicFormula(window.pacejkaWheelLoad,window.pacejkaSlipAngle,window.pacejkaSlipRatio,window.pacejkaCamber);var n=new box2D.dynamics.B2BodyDef;n.type=box2D.dynamics.B2Body.b2_dynamicBody;var l=e.body.getPosition(),c=new Math3D.geometry.Vector2(i,s);c.rotate(o),n.position.set(l.x+c.x,l.y+c.y),n.angle=o;var g=new box2D.collision.shapes.B2PolygonShape;g.setAsBox(.08,.3),this.body=e.body.getWorld().createBody(n),this.body.setUserData(e);var d=new box2D.dynamics.B2FixtureDef;d.shape=g,d.density=1,d.friction=1,d.filter.categoryBits=2,d.filter.maskBits=32767,this.body.createFixture(d);var p=new box2D.dynamics.joints.B2RevoluteJointDef;p.enableLimit=!0,p.lowerAngle=0,p.upperAngle=0,p.bodyA=e.body,p.bodyB=this.body,p.localAnchorA.set(i,s),p.localAnchorB.set(h,a),this.joint=e.body.getWorld().createJoint(p),this.setAngle=function(e){this.joint.setLimits(e,e)},this.getSquealLevel=function(){return this.squealLevel},this.getPosition=function(){var e=this.body.getPosition();return new Math3D.geometry.Vector2(e.x,e.y)},this.set_loadFactor=function(e){return this.loadFactor=Math3D.MyMath.clamp(e,0,2),this.loadFactor},this.update=function(e){var t=this.body.getWorldCenter(),i=this.body.getLinearVelocity(),s=vehicle.Box2DUtils.getFrontVector(this.body);if(this.isDrivingWheel){var h=box2D.common.math.B2Math.mulFV(this.drivingForce,s);this.body.applyForce(h,t)}var a=box2D.common.math.B2Math.dot(i,s),o=Math3D.MyMath.clamp(4*a/(60*e),-1,1),r=box2D.common.math.B2Math.mulFV(-this.brakeForce*o,s);this.body.applyForce(r,t);var n=s.length()*i.length();this.slipAngle=0,0!=n&&(this.slipAngle=box2D.common.math.B2Math.crossVV(s,i)/n);var l=this.magicFormula.calc(this.slipAngle.toDeg());l*=this.loadFactor;var c=Math.min(i.length()/(60*e),1),g=this.body.getWorldVector(new box2D.common.math.B2Vec2(-1,0));g.multiply(l*c),this.body.applyForce(g,t);var d=Math.abs(box2D.common.math.B2Math.dot(i,g));this.squealLevel=Math3D.MyMath.clamp(Math3D.MyMath.linearMap(d,1e4,3e4,0,1),0,1)}};